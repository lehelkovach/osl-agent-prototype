## Codex session primer

- **Bootstrap (fresh Ubuntu/Debian machine)**:
  - Ensure Python 3.12+ is available: `python3 --version`
  - Install venv support (required for `pipx` / Poetry):
    - `sudo apt-get update && sudo apt-get install -y python3.12-venv`
    - (If you’re not on 3.12 specifically, `sudo apt-get install -y python3-venv` is usually sufficient.)
  - Install Poetry (recommended) via pipx:
    - `python3 -m pip install --user pipx`
    - `~/.local/bin/pipx install poetry`
    - Ensure it’s on PATH: `export PATH="$HOME/.local/bin:$PATH"`
  - Install repo deps and Playwright browsers:
    - `poetry install`
    - `poetry run playwright install --with-deps chromium` (needed for Playwright-backed tests/tools)
  - Run tests: `poetry run pytest`

- **First**: Read `docs/AGENT-HANDOFF.md` for comprehensive project context, current state, and development stages (especially if starting fresh or on a new machine).
- Always read `docs/session-notes.md` at start to recall goals, recent changes, outstanding TODOs, env flags, and last test run.
- Update `docs/session-notes.md` as you make meaningful progress: add recent changes, adjust TODOs/goals/testing status. Keep it concise and current so future sessions can rehydrate quickly.
- Consult project docs/README for context before changing behavior; respect existing patterns.
- Memory adapter focus: keep `MemoryTools` as the swap boundary (Arango, Chroma, in-memory). Plans are JSON-first (`{"commandtype":..., "metadata":{...}}`); fallback legacy `{intent, steps}` parsing remains.
- After executing a plan, persist procedure run stats and link `ProcedureRun` -> `Procedure` via `run_of`; ensure tested/success/failure counters update.
- Tests to know: `tests/test_agent_procedure_run_stats.py` (procedure run stats/linking), `tests/test_memory_contract.py` (MemoryTools contract; optional Chroma/Arango via `TEST_CHROMA`/`TEST_ARANGO` env flags).
- Env flags: `USE_FAKE_OPENAI`, `ASK_USER_FALLBACK`, `USE_CPMS_FOR_PROCS`, `USE_PLAYWRIGHT`, `ARANGO_VERIFY`, etc., live in `.env.local`.
- Note: `.env.local` is not committed; it currently holds ARANGO_* and OPENAI_* values. Load it at start (tests and service already do) and keep secrets local.
- Workflow expectations: when I say “debug,” do not run full tests; check logs (`log_dump.txt`) and reason. When asked to run tests, execute pytest; otherwise avoid unnecessary runs. Respect “don’t run tests when running debug.”
- Debug loop guidance: start/ensure the agent daemon is running; send requests via curl/script to the agent; tail/read `log_dump.txt`, then clear it between iterations to isolate responses; if you hit a bug, stop the daemon, apply the fix, restart, and repeat the curl/log cycle.
- After completing code changes for a goal and resolving bugs, commit to the repo with a brief, descriptive message. Annotate your actions: when halting for user input, report what you were doing, what got fixed, what’s next, and which planned items remain.
- Keep changes ASCII; add comments only when non-obvious. Use `rg` for search. Use `apply_patch` for edits. Do not revert user changes.
- When finishing a task, report: last issues, what you tried, what’s fixed, what remains relative to stated goals. Update `docs/session-notes.md` with current state.
- For web automation plans: LLM should produce JSON commands; ask for missing credentials; associate URL seeds to stored credentials in memory (vault-like) when applicable. Query preferences before autofill if stored.
- Queueing: LLM can emit `queue.enqueue` with priority/due/not_before or delay_seconds to push work onto the priority queue; `queue.update` adjusts priorities/status later.
- If a skill is required by name, open its `SKILL.md` and follow instructions. Use skills only when triggered.

---

## Salvage refactor plan (2026-01-14)

Reference doc (kept verbatim in this repo): `docs/salvage-osl-agent-prototype.txt`.

### What to keep (do not churn)
- Keep `MemoryTools` as the swap boundary (Arango/Chroma/in-memory) and keep/extend the contract tests.
- Keep the JSON-first planning contract + legacy `{intent, steps}` fallback parsing.
- Keep the current CPMS + autofill direction and the “reuse-first patterns” milestone path from `docs/development-plan.md`.

### What to change (architecture)
- Introduce a **session-scoped activation layer** (“working memory”) that boosts retrieval/ranking *without* polluting long-term semantic memory.
- Add an optional **async replication/flush queue** for background persistence of selected “activation” or edge updates (behind a flag).
- Add a **deterministic parser** as a first-pass classifier for obvious Task/Event/Reminder-style requests (skip LLM when safe).
- Defer “immutable prototype model” until after the above is stable; implement as *additive* (new type + version chains) before attempting any migration.

### What to add next (in order; each step independently testable)
- Step A: Add `src/personal_assistant/working_memory.py` + `tests/test_working_memory.py` (port WorkingMemoryGraph idea; NetworkX-backed).
- Step B: Add `src/personal_assistant/async_replicator.py` + tests (queue + worker pattern). Keep it optional/off by default.
- Step C: Add `src/personal_assistant/deterministic_parser.py` + tests (rule-based kind inference + basic field extraction).
- Step D: Integrate working memory into the agent retrieval path:
  - Boost memory search results by activation.
  - Reinforce activation when a result is selected/executed.
  - Keep the activation graph separate from semantic storage; only persist via async replicator if explicitly enabled.
- Step E (later): Add immutable prototype/version-chain model for KSG seeding and schema evolution (minimal surface area first).

### Guardrails
- Avoid mixing activation weights into the primary “semantic” score; compute a separate `_activation_boost` and combine via a small tunable multiplier.
- Prefer env flags for behavior changes (e.g., deterministic intent shortcut, async replication).
- Keep refactors incremental: land new modules + tests before wiring them into `agent.py`.
